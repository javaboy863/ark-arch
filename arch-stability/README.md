# 1.背景
&emsp;&emsp;
稳定性保障是架构师的基本能力，但稳定性所涉及的范围太广，包括机房、网络、硬件部署、业务场景、交互设计，再到应用架构的代码质量、流量与封网管控、攻防复盘等，是一项非常系统化的工程。

&emsp;&emsp;
稳定性的核心还是稳定性工作的核心还是围绕系统与代码本身来开展，无论是质量团队、各方管控平台，还是研发流程保障机制，最终的稳定性还是体现在系统代码上，着眼于系统设计实现环节的控制。

&emsp;&emsp;
这里我把我的稳定性方案写出来，此方案经历经历次618及双11大促的洗礼，经过多次个版本的迭代而形成。其中测试环境稳定性的建设属于稳定性建设的其中的一环，在此我特别单独写出来，具体实施策略可以看我之前写的：[测试环境稳定性](https://github.com/javaboy863/ark-best-practices/tree/main/testing-environment)

# 2.有哪些不稳定因素
&emsp;&emsp;
我们要做稳定性保障，就要知道那些不稳定因素是从哪里来的，包括：

&emsp;&emsp;
需求不受控、架构局限、代码扩展性不足、监控日志不统一、下游依赖不统一之类问题导致了每到大促前夕的紧张慌乱，重复的梳理、反复的打补丁，需要额外的进行压力测试，预案配置演练，消耗巨大且效果有限。
# 3.应对策略
&emsp;&emsp;
有了上面不稳定因素的来源分析，我们就知道从哪里开始着手了。我们需要贯穿于系统实现各环节，来制定合理的稳定性策略。

# 4.系统编码实现环节

1、资损控制-定义最合适粒度的资损防控策略

&emsp;&emsp;
电商的要求严苛程度与金融软件是不一样的，不断叠加的机制、流程会带来新的问题。尤其针对电商创新型业务，是需要结合具体业务场景具体分析，在稳定性保障与业务创新迭代效率之间找到一个平衡点，定义最合适粒度的资损防控策略。

2、极限兜底保护稳定性

&emsp;&emsp;
紧急情况事故无可避免，但是我们可以把损失降低到最小，无论在任何情况下，当前端或者服务端出现任何异常的情况下，不允许用户看到诸如500，404，空白页之类的页面。这需要全面的异常分支分析+与产品人员的充分对焦+充分的兜底场景测试。

2.1 单机qps限流2

2.2 自适应系统load限流

2.3 消息接收处理线程数控制



3、隐患配置梳理     
&emsp;&emsp;
关键项配置梳理：各种连接池配置，超时和重试配置，限流降级配置

4、通用系统模块稳定性
- 统一对外服务层异常兜底
- 统一结果码
- 统一摘要日志
- 统一摘要监控
- 统一下游依赖模块
- 统一线程池管理
- 统一消息订阅管理
- 统一定时任务
- 报文网关交互
- 文件解析模块抽取
- 防腐层建设
- 报警设置和治理

5、可压测性能力建设        
&emsp;&emsp;
为了支持系统的可压测，需要考虑系统需要满足怎样的设计。

6、服务端CI能力建设        
&emsp;&emsp;
单元测试关注单个类单个方法的逻辑正确性，接口集成测试一般关注单个系统单个service方法的逻辑正确性。具体这个层面做到什么程度需要依赖业务场景而定，比如高风险、模型稳定的核心系统就必须需要严格要求自动化覆盖率，而创新型快速迭代的新业务讲究快跑覆盖核心流程比较合适。

7、上下游SLA稳定性        
&emsp;&emsp;
SLA是一种约定，目的是确保接口提供方和使用方能够对接口有一致的理解，能够更好的保障业务活动进行，同时在发生线上故障必须要进行定责的时候，是一份参照标准，一份免责声明。
个人认为可以不局限于形式，但一定要可追溯，文档或者清晰的接口注释都具备同样效力。

8、代码实现规范稳定性        
&emsp;&emsp;
主要是编码规范及对应的落地措施及CodeReview机制。

9、技术架构与选型稳定性

可以参考：

[ark宇宙](https://github.com/javaboy863/ark-universe)

[分层框架](https://github.com/javaboy863/ark-layer-framework)

[分层框架](https://github.com/javaboy863/ark-sample-clean-code)

10、业务需求把控的稳定性

&emsp;&emsp;
业务需求把控与稳定性关系从业务需求层面考虑稳定性，主要是做两个方面，一是业务需求过滤(价值判断)，二是需求模型简化。

11、业务领域模型稳定性

&emsp;&emsp;
基于业务架构抽象出业务的核心主体及其主体之间的协作关系，确保清晰准确的理解了需求现在要做，未来要做，未来可能做的事情有哪些，基于对这个的理解，设计稳定可靠可扩展的模型，确保业务领域模型的稳定。

12、发现能力基础建设（第一时间发现问题）：

&emsp;&emsp;
绝大部分的稳定工作都是围绕四个要素在投入，梳异常链路、映射错误码、加日志、加监控。针对这些问题，我们需要有统一的、尽可能低成本低侵入的解决方案和标准，在日常的研发过程中就尽量随时准备好。 
- 统一错误码标准
- 统一异常处理
- 统一参数校验机制
- 统一日志输出规范
- 统一合适的业务监控机制
  - mtop层方法执行超过500ms
  - 错误码环比大涨
  - 异常量大涨
  - 出现未知异常
  - 特定业务场景告警层
- 建立业务系统统一大盘
  
    &emsp;&emsp;
    在某一个时刻，想知道系统各业务是否都运行正常，就需要有全局视角的业务大盘。在这个大盘上可以覆盖系统的主要业务场景，承担系统晴雨表的效果，关键时候可以一目了然。

13、恢复能力建设        
- 业务降级
- 业务限流
- 自动补偿
- 人工介入能力
- 接口自动探测，自动切换能力

14、业务大环境，业务架构稳定性

&emsp;&emsp;
先要清晰认识了解所在部门大的业务环境、背景、未来趋势。确保我们和业务方能建立业务架构上的共识，目标一致。以此为基石，保证方向正确的前提下，贴合实际去考虑系统架构与边界问题，做配套的稳定性方案！

15、持续重构与稳定性的关系

&emsp;&emsp;
在业务先赢的时代背景下，特定时候不得不做妥协，不得不上临时方案，这样导致即使原本优雅稳定的系统实现，依然会被一点点扭曲，形成越来越多的技术债。这些技术债会成为越来越大的绊脚石，除了会障碍业务快速发展，更会直接带来额外稳定性风险和巨大的人力开销。我们必须要做持续的重构来偿还。


# 5.结尾
&emsp;&emsp;
经过了上面的处理，你的系统想变得不稳定都难，但因为上面事项较多，需要分步骤、分阶段、分主次依次实施建设。


